<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: main.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: main.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
* Header
* Author Alexander RUpprecht
* Version: 1.0.0
* Beschreibung: Klasse enthält alle Methoden die von der Datenbank abhängig sind
* Copyright : Technische Hochschule Deggendorf
* Datum: 31.01.2020
*/

/**
 * &lt;h1>Budgeteer Main-Script&lt;/h1>
 * 
 * Beschreibung: Enthält sämtliche Methoden die mit der Datenbank in Verbindung stehen 
 * @author Alexander Rupprecht
 * @version 1.0.0
 * @copyright Technische Hochschule Deggendorf
 */
window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
// Verwenden Sie "var indexedDB = ..." NICHT außerhalb einer Funktion.
// Ferner benötigen Sie evtl. Referenzen zu einigen window.IDB* Objekten:
window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
// (Mozilla hat diese Objekte nie mit Präfixen versehen, also brauchen wir kein window.mozIDB*)

var request = window.indexedDB.open("BudgeteerDB", 1);
var db;

request.onsuccess = function (event) {
    db = request.result;
    update();
};
request.onupgradeneeded = function (event) {
    db = event.target.result;
    var objectStore = db.createObjectStore("Storage", { keyPath: "id", autoIncrement: true });
    objectStore.createIndex("Bereich", "Bereich", { unique: true });
    objectStore.createIndex("Budget", "Budget", { unique: false });
    objectStore.createIndex("Rechnungen", "Rechnungen", { unique: false });
}

var currentId;
$.mobile.loading().hide();

if (!window.indexedDB) {
    alert("IndexedDB wird nicht unterstützt!");
};
/**
 * Funktion um einen neuen Bereich zu erstellen
 * @param {*} form - Formular mit Name und Betrag  
 */
function addBereich(form) {

    var bereich = form.name1.value;
    var amount = form.amount1.value;
    var rechnungen = [];

    if (amount === "" || bereich === "") {
        alert('Bitte gültige Daten eingeben');
        window.location.replace('#addBereich');
    }
    else {
        var trans = db.transaction(["Storage"], "readwrite");
        var store = trans.objectStore("Storage");
        var request = store.put({ Bereich: bereich, Budget: amount, Rechnungen: rechnungen });

        request.onsuccess = function (event) {
            update();
            window.location.replace("#start");
        }

        request.onerror = function (event) {
            alert('Bitte einzigartigen Titel eingeben');
        }
    }
}

/**
 * Methode um Bereich zu löschen
 * @param {*} set - Datenset des zu löschenden Bereichs
 */
function deleteBereich(set) {

    var trans = db.transaction(["Storage"], "readwrite");
    var store = trans.objectStore("Storage");
    var request = store.delete(set.id);
    update();
    location.reload();
}
/**
 * Methode die Rechnung zum Bereich hinzufügt
 * @param {*} form - Formulardaten
 */
function addRechnung(form) {
    var name = form.name2.value;
    var amount = form.amount2.value;

    if (amount === "") {
        alert('Bitte gültigen Betrag eingeben');
        window.location.replace('#addRechnung');
    }
    else {
        var rechnung = new Rechnung(amount, name);
        var trans = db.transaction(["Storage"], "readwrite");
        var store = trans.objectStore("Storage");
        var row = store.get(currentId);

        row.onsuccess = function (event) {
            var trans = db.transaction(["Storage"], "readwrite");
            var store = trans.objectStore("Storage");
            var data = event.target.result;
            data.Rechnungen.push(rechnung);

            store.put(data);
            update();
            window.location.replace("#start");
        }
    }
}
/**
 * Methode, die Rechnung entfernt
 * @param {rechnung} rechnung - zu löschende Rechnung
 */
function deleteRechnung(rechnung) {
    var trans = db.transaction(["Storage"], "readwrite");
    var store = trans.objectStore("Storage");
    var set = store.get(currentId);

    set.onsuccess = function (event) {
        var trans = db.transaction(["Storage"], "readwrite");
        var store = trans.objectStore("Storage");
        var data = event.target.result;
        var index = data.Rechnungen.map(function (e) { return e.name }).indexOf(rechnung.name);
        data.Rechnungen.splice(index, 1);
        store.put(data);
        update();
        window.location.replace("#start");
    }
}

/**
 * Methode die Content von db lädt und in Startseite und Übersicht einfügt
 */
function update() {

    var trans = db.transaction("Storage", "readonly");
    var objectStore = trans.objectStore("Storage");

    var request = objectStore.openCursor();
    var content = document.createElement("div");
    content.setAttribute('id', 'folders');
    request.onsuccess = function (event) {
        var cursor = event.target.result;
        if (cursor) {

            var info = cursor.value;
            currentId = info.id;
            var moneyLeft = cursor.value.Budget;
            var budgetListItem = document.createElement("div");
            var item = document.createElement("a");
            budgetListItem.className = "BudgetListItem";
            item.setAttribute('href', '#uebersicht');
            item.setAttribute('id', info.Bereich);
            var bereichDeleter = document.createElement("input");
            bereichDeleter.setAttribute('type', 'button');
            bereichDeleter.setAttribute('value', 'x');
            bereichDeleter.setAttribute('class', 'BereichDeleter');
            bereichDeleter.setAttribute('data-role', 'none');
            bereichDeleter.addEventListener("click", function (e) { deleteBereich(info) });

            info.Rechnungen.forEach(element => { moneyLeft = moneyLeft - element.amount; });
            item.onclick = function () {

                currentId = info.id;
                var header = document.createElement("div");
                var uebersichtMoney = document.createElement("div");
                uebersichtMoney.setAttribute('id', 'MoneyLeft');
                var uebersichtMoneyText = document.createTextNode(moneyLeft + "€ übrig");
                uebersichtMoney.appendChild(uebersichtMoneyText);
                var ueberschrift = document.createTextNode(info.Bereich);
                header.setAttribute('id', 'ueberschrift');
                header.appendChild(ueberschrift);

                var alteUeberschrift = document.getElementById('ueberschrift');
                document.getElementById("uebersichtHeader").replaceChild(header, alteUeberschrift);

                var child2 = document.getElementById('MoneyLeft');
                document.getElementById("uebersichtHeader").replaceChild(uebersichtMoney, child2);

                var rechnungenContainer = document.createElement("div");
                rechnungenContainer.setAttribute('id', 'rechnungen');

                info.Rechnungen.forEach(element => {
                    var rechnung = document.createElement("div");
                    rechnung.setAttribute('class', 'Rechnung');
                    var label = document.createTextNode(element.name + "  " + element.amount + "€");
                    var deleter = document.createElement("input");
                    deleter.setAttribute('type', 'button');
                    deleter.setAttribute('value', 'x');
                    deleter.setAttribute('class', 'BereichDeleter');
                    deleter.setAttribute('data-role', 'none');
                    deleter.addEventListener("click", function (e) { deleteRechnung(element) });
                    rechnung.appendChild(label);
                    rechnung.appendChild(deleter);
                    rechnungenContainer.appendChild(rechnung);
                });

                var uebersichtContent = document.getElementById("uebersichtContent");
                var alteRechnungen = document.getElementById("rechnungen");
                uebersichtContent.replaceChild(rechnungenContainer, alteRechnungen);
            };

            var node = document.createTextNode(cursor.value.Bereich + "  " + moneyLeft + "€/" + cursor.value.Budget + "€");
            if (moneyLeft &lt; cursor.value.Budget / 10) {
                budgetListItem.setAttribute('class', 'RedBudgetListItem');
            };
            item.appendChild(node);
            budgetListItem.appendChild(item);
            budgetListItem.appendChild(bereichDeleter)
            content.appendChild(budgetListItem);

            cursor.continue();
        }
        else {

            var startContent = document.getElementById("startContent");
            var folders = document.getElementById("folders");
            startContent.replaceChild(content, folders);


        }
    };
}





</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Rechnung.html">Rechnung</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addBereich">addBereich</a></li><li><a href="global.html#addRechnung">addRechnung</a></li><li><a href="global.html#deleteBereich">deleteBereich</a></li><li><a href="global.html#deleteRechnung">deleteRechnung</a></li><li><a href="global.html#update">update</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Fri Jan 31 2020 07:25:54 GMT+0100 (Mitteleuropäische Zeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
